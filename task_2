with deal as (
	select a.deal_id,
	a.partner_id,
	a.dt_deal::date
	from (values 
	(51992839, '2023-01-18', 259806),
	(51995529, '2023-01-13', 295929),
	(52012729, '2023-02-22', 275860),
	(52022319, '2023-02-06', 241765),
	(52026369, '2023-01-20', 289692),
	(52020031, '2023-01-27', 244415),
	(52031150, '2023-01-13', 274519),
	(52033273, '2023-01-26', 240810),
	(52035359, '2023-01-13', 268790),
	(52033371, '2023-01-17', 267138),
	(52038259, '2023-01-23', 283996),
	(52038911, '2023-02-14', 250720),
	(52039119, '2023-01-06', 273555),
	(52036879, '2023-01-23', 242467),
	(52031979, '2023-01-12', 290157),
	(52033580, '2023-01-18', 266263),
	(51989869, '2023-01-11', 295929),
	(51857819, '2023-02-03', 258854),
	(5731929, '2023-01-13', 270575),
	(52036739, '2023-01-19', 283988),
	(51979532, '2023-01-17', 275558),
	(52053060, '2023-01-26', 259806),
	(52063000, '2023-01-12', 244415),
	(52062659, '2023-02-09', 258050),
	(52066119, '2023-02-28', 244415),
	(52069679, '2023-02-24', 286645),
	(50983250, '2023-02-04', 262406),
	(52073839, '2023-02-04', 270271),
	(52077679, '2023-02-09', 272071),
	(52083309, '2023-02-13', 261317),
	(52080597, '2023-02-13', 259806),
	(52070939, '2023-02-13', 279610),
	(52085611, '2023-02-12', 267271),
	(39057035, '2023-02-06', 262258),
	(52088959, '2023-02-17', 259806),
	(52087659, '2023-02-13', 289692),
	(52093755, '2023-02-09', 248776),
	(52095180, '2023-02-08', 250562),
	(52099059, '2023-02-09', 266276),
	(52097199, '2023-01-10', 280855),
	(52099619, '2023-01-09', 295929),
	(52101951, '2023-01-30', 244415),
	(52106299, '2023-01-12', 259806),
	(52110969, '2023-01-02', 257443),
	(52115139, '2023-01-04', 242458),
	(52113769, '2023-01-10', 296067),
	(52123309, '2023-01-16', 258464),
	(52125379, '2023-01-13', 282331),
	(52130309, '2023-01-13', 277146),
	(52132290, '2023-01-11', 259806),
	(52133399, '2023-01-12', 244415),
	(52080792, '2023-01-18', 245730),
	(52029379, '2023-01-11', 237824),
	(52136302, '2023-01-17', 258547),
	(52091391, '2023-01-03', 277227),
	(52130020, '2023-01-16', 253123),
	(52023719, '2023-01-13', 238974),
	(52135229, '2023-01-04', 244415),
	(51336739, '2023-01-06', 261667),
	(52135569, '2023-01-11', 289630),
	(52144873, '2023-02-06', 236633),
	(52149300, '2023-02-02', 237801),
	(52153161, '2023-01-05', 287843),
	(52152661, '2023-01-17', 236616),
	(52155370, '2023-01-04', 255004),
	(52160279, '2023-01-05', 285292),
	(52160760, '2023-01-27', 278442),
	(52162081, '2023-01-17', 245941),
	(52156961, '2023-01-04', 277228),
	(52165179, '2023-01-11', 271985),
	(52158329, '2023-01-05', 238902),
	(50853588, '2023-02-01', 290712),
	(52172380, '2023-01-10', 295416),
	(52173519, '2023-01-20', 244415),
	(52055330, '2023-01-05', 244415),
	(52187011, '2023-01-14', 253630),
	(52185309, '2023-01-11', 267405),
	(51759900, '2023-01-09', 244900),
	(52190659, '2023-01-05', 242486),
	(52197929, '2023-01-05', 293911),
	(31055736, '2023-01-05', 265242),
	(52198879, '2023-01-20', 260079),
	(51268617, '2023-01-06', 262791),
	(52199170, '2023-01-04', 293266),
	(52030689, '2023-01-13', 271289),
	(52201709, '2023-01-05', 275035),
	(33559315, '2023-01-17', 244415),
	(51210238, '2023-01-11', 260285),
	(51758851, '2023-01-11', 256823),
	(52223239, '2023-01-17', 241118),
	(52228619, '2023-01-17', 241454),
	(52232139, '2023-01-05', 289692),
	(52231972, '2023-01-09', 287112),
	(52233730, '2023-01-31', 273867),
	(52237859, '2023-01-12', 259408),
	(52231330, '2023-01-04', 261653),
	(52232831, '2023-01-13', 293815),
	(52220239, '2023-01-24', 244415),
	(36053538, '2023-01-05', 247136),
	(52255619, '2023-01-13', 252736)
	) as a (deal_id,dt_deal,partner_id)
),
partner as (
	select 
	a.partner_office_id,
	a.partner_id,
	a.holding
	from
	(
		values
		(12088,259806,'Этажи'),
		(12088, 259806, 'Этажи'),
		(18392, 295929, 'Самолет'),
		(17631, 275860, 'Centure24'),
		(16785, 241765, 'нет холдинга'),
		(13063, 289692, 'нет холдинга'),
		(14151, 244415, 'нет холдинга'),
		(13153, 274519, 'нет холдинга'),
		(10942, 240810, 'нет холдинга'),
		(13438, 268790, 'нет холдинга'),
		(10171, 267138, 'нет холдинга'),
		(14343, 283996, 'нет холдинга'),
		(19224, 250720, 'нет холдинга'),
		(16702, 273555, 'нет холдинга'),
		(11196, 242467, 'нет холдинга'),
		(11932, 290157, 'нет холдинга'),
		(16625, 266263, 'нет холдинга'),
		(15376, 267117, 'нет холдинга'),
		(11105, 258854, 'нет холдинга'),
		(10597, 270575, 'нет холдинга'),
		(18591, 283988, 'нет холдинга'),
		(19569, 275558, 'нет холдинга'),
		(10500, 259806, 'Этажи'),
		(17277, 258050, 'нет холдинга'),
		(16106, 286645, 'нет холдинга'),
		(11627, 262406, 'нет холдинга'),
		(14149, 270271, 'нет холдинга'),
		(12837, 272071, 'нет холдинга'),
		(11417, 261317, 'нет холдинга'),
		(15954, 279610, 'нет холдинга'),
		(10835, 267271, 'нет холдинга'),
		(19296, 262258, 'нет холдинга'),
		(14847, 248776, 'нет холдинга'),
		(17070, 250562, 'нет холдинга'),
		(15183, 266276, 'нет холдинга'),
		(11875, 280855, 'нет холдинга'),
		(10027, 283545, 'нет холдинга'),
		(18155, 257443, 'нет холдинга'),
		(14003, 242458, 'нет холдинга'),
		(12665, 296067, 'нет холдинга'),
		(19730, 258464, 'нет холдинга'),
		(19870, 282331, 'нет холдинга'),
		(18568, 277146, 'нет холдинга'),
		(17591, 245730, 'нет холдинга'),
		(17806, 237824, 'нет холдинга'),
		(10804, 258547, 'нет холдинга'),
		(12024, 277227, 'нет холдинга'),
		(11548, 253123, 'нет холдинга'),
		(18380, 238974, 'нет холдинга'),
		(14162, 261667, 'нет холдинга'),
		(10145, 289630, 'нет холдинга'),
		(14512, 236633, 'нет холдинга'),
		(13959, 237801, 'нет холдинга'),
		(15573, 287843, 'нет холдинга'),
		(14961, 236616, 'нет холдинга'),
		(10845, 255004, 'нет холдинга'),
		(12630, 285292, 'нет холдинга'),
		(17785, 278442, 'нет холдинга'),
		(17703, 245941, 'нет холдинга'),
		(14928, 277228, 'нет холдинга'),
		(18642, 271985, 'нет холдинга'),
		(15884, 238902, 'нет холдинга'),
		(13980, 290712, 'нет холдинга'),
		(12748, 295416, 'нет холдинга'),
		(15406, 253630, 'нет холдинга'),
		(17798, 267405, 'нет холдинга'),
		(17099, 244900, 'нет холдинга'),
		(17378, 242486, 'нет холдинга'),
		(17148, 293911, 'нет холдинга'),
		(18755, 265242, 'нет холдинга'),
		(11181, 260079, 'нет холдинга'),
		(16708, 262791, 'нет холдинга'),
		(15724, 293266, 'нет холдинга'),
		(15521, 271289, 'нет холдинга'),
		(14238, 275035, 'нет холдинга'),
		(18092, 260285, 'нет холдинга'),
		(16912, 256823, 'нет холдинга'),
		(12594, 241118, 'нет холдинга'),
		(18155, 241454, 'нет холдинга'),
		(10195, 287112, 'нет холдинга'),
		(15855, 273867, 'нет холдинга'),
		(13746, 259408, 'нет холдинга'),
		(18534, 261653, 'нет холдинга'),
		(11517, 293815, 'нет холдинга'),
		(10859, 247136, 'нет холдинга'),
		(19472, 252736, 'нет холдинга'),
		(19032, 295929, 'Самолет'),
		(13386, 273867, 'нет холдинга'),
		(13628, 293266, 'нет холдинга'),
		(19035, 295929, 'Самолет'),
		(19033, 295929, 'Самолет'),
		(19034, 295929, 'Самолет'),
		(19034,295929,'Самолет')
		) as a (partner_office_id, partner_id, holding)
)


------------


select 
	dt_deal::date as dt,
	date_trunc('week',dt_deal)::date wk,
	date_trunc('month',dt_deal)::date mth,
	date_trunc('quarter',dt_deal)::date qrt,
	holding,
	count(distinct deal_id) --добавил distinct, тк сделки дублировались (партнеры меняли офис)
from deal d
left join partner p on p.partner_id=d.partner_id
group by 
	grouping sets ((1, 5), (2, 5), (3, 5), (4, 5))
